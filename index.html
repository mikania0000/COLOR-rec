<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¬ç‰©è¾¨è­˜æƒæå™¨ v2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.1/dist/tesseract.min.js"></script>
    <style>
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(168, 85, 247, 0.8);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.8);
            top: 0;
            animation: scan 2s linear infinite;
            display: none;
            z-index: 10;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #a855f7;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-glow { box-shadow: 0 0 25px rgba(168, 85, 247, 0.4); }
        .focus-bracket {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(168, 85, 247, 0.6);
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen font-sans text-slate-100">

    <div class="max-w-md mx-auto min-h-screen flex flex-col shadow-2xl bg-slate-800">
        <!-- Header -->
        <header class="p-5 text-center border-b border-slate-700">
            <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 via-blue-400 to-emerald-400 bg-clip-text text-transparent">
                AI è¬ç‰©è¾¨è­˜æƒæå™¨
            </h1>
            <div class="flex justify-center items-center gap-2 mt-1">
                <p class="text-slate-400 text-[10px] uppercase tracking-wider">Vision Engine v2.2</p>
                <span class="bg-purple-900/50 text-[10px] px-1.5 py-0.5 rounded text-purple-300 border border-purple-500/30 font-mono italic">Handwriting Opt.</span>
            </div>
        </header>

        <!-- ç›¸æ©Ÿé è¦½å€ -->
        <main class="flex-grow p-4 space-y-4">
            <div class="relative bg-black rounded-2xl overflow-hidden aspect-[3/4] shadow-inner border border-slate-700 group">
                <video id="cameraVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                <div id="scanLine" class="scan-line"></div>

                <!-- å°ç„¦æ¡†å‹•ç•« -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-48 h-32 border-2 border-white/20 rounded-lg flex items-center justify-center">
                        <div class="text-[10px] text-white/40 uppercase tracking-tighter">å°‡æ‰‹å¯«æ–‡å­—ç½®æ–¼æ­¤æ¡†</div>
                    </div>
                </div>

                <!-- ç‹€æ…‹é®ç½© -->
                <div id="statusOverlay" class="absolute inset-0 bg-slate-900/90 hidden flex-col items-center justify-center space-y-4 transition-opacity z-20">
                    <div class="loading-spinner"></div>
                    <div class="text-center">
                        <p id="progressLabel" class="text-sm font-bold text-purple-300">æ­£åœ¨è§£ææ‰‹å¯«å…§å®¹...</p>
                        <p class="text-[10px] text-slate-500 mt-1">AI æ­£åœ¨å˜—è©¦æ ¹æ“šä¸Šä¸‹æ–‡æ¨æ–·å­—è·¡</p>
                    </div>
                    <div id="progressContainer" class="w-2/3 bg-slate-700 h-1 rounded-full overflow-hidden">
                        <div id="progressBar" class="bg-emerald-500 h-full w-0 transition-all duration-300"></div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œå€ -->
            <div class="flex flex-col space-y-3">
                <button id="aiScanBtn" class="relative bg-gradient-to-br from-purple-600 to-indigo-700 hover:from-purple-500 hover:to-indigo-600 py-4 rounded-xl font-bold text-lg shadow-lg transition-all active:scale-95 overflow-hidden ai-glow">
                    <span class="relative z-10 flex items-center justify-center gap-2">
                        âœ¨ AI æ™ºæ…§æƒæ (æ”¯æ´æ‰‹å¯«)
                    </span>
                </button>
                
                <div class="flex gap-2">
                    <button id="scanBtn" class="flex-1 bg-slate-700 hover:bg-slate-600 py-3 rounded-lg text-sm font-medium transition-all border border-slate-600">
                        ğŸ“„ å¿«é€Ÿæƒææ–‡å­—
                    </button>
                    <label class="flex-1 bg-slate-700 hover:bg-slate-600 py-3 rounded-lg text-sm font-medium text-center cursor-pointer transition-all border border-slate-600">
                        ğŸ“ ä¸Šå‚³åœ–ç‰‡
                        <input type="file" id="fileInput" accept="image/*" class="hidden">
                    </label>
                </div>
            </div>

            <!-- è¾¨è­˜çµæœ -->
            <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700 space-y-3">
                <div class="flex justify-between items-center">
                    <span id="resultTag" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-800 px-2 py-1 rounded">ç­‰å¾…æƒæ</span>
                    <div class="flex gap-3">
                        <button id="clearBtn" class="text-xs text-slate-500 hover:text-red-400 transition-colors">æ¸…é™¤</button>
                        <button id="copyBtn" class="text-xs text-blue-400 hover:text-blue-300 font-bold hidden">è¤‡è£½å…¨éƒ¨</button>
                    </div>
                </div>
                <div id="resultArea" class="min-h-[140px] max-h-[280px] overflow-y-auto text-slate-200 text-sm leading-relaxed whitespace-pre-wrap">
                    <span class="text-slate-500 italic">å°æé†’ï¼šè¾¨è­˜æ‰‹å¯«å­—æ™‚ï¼Œè«‹å„˜é‡ä¿æŒé¡é ­ç©©å®šä¸”å…‰ç·šå……è¶³ã€‚</span>
                </div>
            </div>
        </main>

        <footer class="p-4 text-center border-t border-slate-700 bg-slate-800/50">
            <p class="text-[9px] text-slate-500 uppercase tracking-widest">
                Handwriting Optimization Engine | System v2.2
            </p>
        </footer>

        <canvas id="processCanvas" class="hidden"></canvas>
    </div>

    <script>
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('processCanvas');
        const scanBtn = document.getElementById('scanBtn');
        const aiScanBtn = document.getElementById('aiScanBtn');
        const clearBtn = document.getElementById('clearBtn');
        const fileInput = document.getElementById('fileInput');
        const resultArea = document.getElementById('resultArea');
        const resultTag = document.getElementById('resultTag');
        const statusOverlay = document.getElementById('statusOverlay');
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const progressContainer = document.getElementById('progressContainer');
        const scanLine = document.getElementById('scanLine');
        const copyBtn = document.getElementById('copyBtn');

        let isScanning = false;
        const apiKey = ""; 

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', 
                        width: { ideal: 1920 }, 
                        height: { ideal: 1080 } 
                    },
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                resultArea.innerHTML = "<span class='text-red-400'>âš ï¸ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿã€‚è«‹ç¢ºä¿ä½¿ç”¨ HTTPS ä¸¦æˆæ¬Šç›¸æ©Ÿæ¬Šé™ã€‚</span>";
            }
        }

        function getBase64Image() {
            const ctx = canvas.getContext('2d');
            // ç¢ºä¿æ“·å–è§£æåº¦èˆ‡è¦–è¨Šæµä¸€è‡´
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            // æå‡å“è³ªåˆ° 0.95 æ¸›å°‘ OCR é›œè¨Š
            return canvas.toDataURL('image/jpeg', 0.95).split(',')[1];
        }

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error('API Error');
                return await response.json();
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        // å°ˆç‚ºæ‰‹å¯«å„ªåŒ–çš„ AI è¾¨è­˜é‚è¼¯
        async function runSmartAI(base64Data) {
            if (isScanning) return;
            isScanning = true;
            
            statusOverlay.classList.remove('hidden');
            progressContainer.classList.add('hidden');
            progressLabel.innerText = "æ­£åœ¨åˆ†ææ‰‹å¯«å­—èˆ‡å½±åƒ...";
            scanLine.style.display = 'block';

            try {
                // æ›´åŠ å¼·åŒ–é‡å°æ‰‹å¯«æ–‡å­—çš„ Prompt
                const prompt = "ä½ æ˜¯ä¸€å€‹é«˜éš OCR èˆ‡è¦–è¦ºå°ˆå®¶ã€‚è«‹ä»”ç´°è¾¨è­˜é€™å¼µåœ–ç‰‡ï¼š\n1. ã€æ‰‹å¯«å­—è¾¨è­˜ã€‘ï¼šæå–æ‰€æœ‰æ‰‹å¯«æˆ–å°åˆ·çš„æ–‡å­—èˆ‡æ•¸å­—ã€‚å¦‚æœå­—è·¡æ½¦è‰ï¼Œè«‹çµåˆå‰å¾Œæ–‡èˆ‡é‚è¼¯ï¼ˆå¦‚å¸³å–®æ ¼å¼ã€æ—¥æœŸã€äººåï¼‰æ¨è«–æ­£ç¢ºæ–‡å­—ã€‚ä¸è¦æ¼æ‰ä»»ä½•æ•¸å­—ã€‚\n2. ã€ç‰©ä»¶è¾¨è­˜ã€‘ï¼šæè¿°åœ–ç‰‡ä¸­çœ‹åˆ°çš„å‹•ç‰©ã€æ°´æœæˆ–é‡è¦ç‰©å“ã€‚\n3. ã€æ‘˜è¦ã€‘ï¼šç°¡çŸ­ç¸½çµã€‚ \nè¼¸å‡ºæ ¼å¼ï¼šè«‹ç›´æ¥ç”¨ç¹é«”ä¸­æ–‡åˆ†é¡åˆ—å‡ºçµæœï¼Œä¸è¦æœ‰ä»»ä½•å¤šé¤˜çš„å¼•è¨€ã€‚";
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                        ]
                    }]
                };

                const result = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    resultArea.innerText = text.trim();
                    resultTag.innerText = "âœ¨ AI å¢å¼·è¾¨è­˜å®Œæˆ";
                    resultTag.className = "text-[10px] font-bold text-white uppercase tracking-widest bg-purple-600 px-2 py-1 rounded";
                    copyBtn.classList.remove('hidden');
                } else {
                    resultArea.innerText = "AI æƒæå®Œç•¢ï¼Œä½†æœªç™¼ç¾å¯è¾¨è­˜å…§å®¹ã€‚";
                }
            } catch (err) {
                resultArea.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API ç‹€æ…‹ã€‚";
            } finally {
                statusOverlay.classList.add('hidden');
                scanLine.style.display = 'none';
                isScanning = false;
            }
        }

        async function runLocalOCR(base64Data) {
            if (isScanning) return;
            isScanning = true;
            statusOverlay.classList.remove('hidden');
            progressContainer.classList.remove('hidden');
            progressLabel.innerText = "å¿«é€Ÿæ–‡å­—è¾¨è­˜ä¸­...";
            scanLine.style.display = 'block';

            try {
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const p = Math.round(m.progress * 100);
                            progressBar.style.width = `${p}%`;
                        }
                    }
                });
                await worker.loadLanguage('chi_tra+eng');
                await worker.initialize('chi_tra+eng');
                const { data: { text } } = await worker.recognize(`data:image/jpeg;base64,${base64Data}`);
                
                resultArea.innerText = text.trim() || "æœªåµæ¸¬åˆ°æ˜é¡¯å°åˆ·æ–‡å­—ã€‚";
                resultTag.innerText = "ğŸ“„ å¿«é€Ÿæƒæå®Œæˆ";
                resultTag.className = "text-[10px] font-bold text-white uppercase tracking-widest bg-emerald-600 px-2 py-1 rounded";
                copyBtn.classList.remove('hidden');
                await worker.terminate();
            } catch (err) {
                resultArea.innerText = "æœ¬åœ°è¾¨è­˜å¤±æ•—ã€‚";
            } finally {
                statusOverlay.classList.add('hidden');
                scanLine.style.display = 'none';
                isScanning = false;
            }
        }

        aiScanBtn.onclick = () => runSmartAI(getBase64Image());
        scanBtn.onclick = () => runLocalOCR(getBase64Image());

        clearBtn.onclick = () => {
            resultArea.innerHTML = "<span class='text-slate-500 italic'>ç­‰å¾…ä¸‹ä¸€å€‹ç›®æ¨™...</span>";
            copyBtn.classList.add('hidden');
            resultTag.innerText = "ç­‰å¾…æŒ‡ä»¤";
            resultTag.className = "text-[10px] font-bold text-slate-500 uppercase tracking-widest bg-slate-800 px-2 py-1 rounded";
        };

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => runSmartAI(ev.target.result.split(',')[1]);
            reader.readAsDataURL(file);
        };

        copyBtn.onclick = () => {
            const el = document.createElement('textarea');
            el.value = resultArea.innerText;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            const original = copyBtn.innerText;
            copyBtn.innerText = "âœ… å·²è¤‡è£½";
            setTimeout(() => copyBtn.innerText = original, 2000);
        };

        startCamera();
    </script>
</body>
</html>